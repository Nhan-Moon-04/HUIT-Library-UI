<!-- Modern Booking Detail Page -->
<div class="modern-booking-detail">
    <!-- Header Section -->
    <div class="detail-header">
        <div class="container">
            <div class="header-content">
                <div class="breadcrumb">
                    <button class="back-btn" (click)="goBack()">
                        <i class="fas fa-arrow-left"></i>
                        <span>Lịch sử mượn phòng</span>
                    </button>
                    <i class="fas fa-chevron-right separator"></i>
                    <span class="current-page">Chi tiết đặt phòng</span>
                </div>

                @if (!loading() && bookingDetail()) {
                <div class="header-info">
                    <div class="booking-title">
                        <h1>{{ bookingDetail()!.tenPhong }}</h1>
                        <span class="booking-id">#{{ bookingDetail()!.maDangKy }}</span>
                    </div>
                    <div class="status-section">
                        <div class="status-badge" [ngClass]="getStatusClass(bookingDetail()!.maTrangThai)">
                            <i class="fas" [ngClass]="getStatusIcon(bookingDetail()!.maTrangThai)"></i>
                            <span>{{ bookingDetail()!.tenTrangThai }}</span>
                        </div>
                        @if (hasViolations()) {
                        <div class="violation-indicator">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>{{ violations().length }} vi phạm</span>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
    </div>

    <!-- Main Content -->
    @if (!loading() && bookingDetail()) {
    <div class="detail-content">
        <div class="container">
            <div class="content-grid">
                <!-- Room Information Card -->
                <div class="detail-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-door-open"></i>
                            <h3>Thông tin phòng</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Tên phòng</label>
                                <span class="value primary">{{ bookingDetail()!.tenPhong }}</span>
                            </div>
                            <div class="info-item">
                                <label>Loại phòng</label>
                                <span class="value">{{ bookingDetail()!.tenLoaiPhong }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Violations Card -->
                @if (violations().length > 0) {
                <div class="detail-card violation-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Biên bản vi phạm ({{ violations().length }})</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="violation-list">
                            @for (violation of violations(); track violation.maViPham) {
                            <div class="violation-item" (click)="viewViolationDetail(violation.maViPham)">
                                <div class="violation-icon" [class]="getViolationStatusClass(violation.trangThaiXuLy)">
                                    <i class="fas" [ngClass]="getViolationStatusIcon(violation.trangThaiXuLy)"></i>
                                </div>
                                <div class="violation-content">
                                    <h5>{{ violation.tenViPham }}</h5>
                                    @if (violation.moTaNgan) {
                                    <p class="violation-description">{{ violation.moTaNgan }}</p>
                                    }
                                    <div class="violation-meta">
                                        <span class="violation-date">
                                            <i class="fas fa-calendar"></i>
                                            {{ formatViolationDate(violation.ngayLap) }}
                                        </span>
                                        <span class="violation-status"
                                            [class]="getViolationStatusClass(violation.trangThaiXuLy)">
                                            {{ violation.trangThaiXuLy }}
                                        </span>
                                    </div>
                                </div>
                                <div class="violation-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                            }
                        </div>

                        @if (loadingViolations()) {
                        <div class="loading-violations">
                            <div class="spinner"></div>
                            <span>Đang tải biên bản...</span>
                        </div>
                        }
                    </div>
                </div>
                }

                <!-- Schedule Information Card -->
                <div class="detail-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>Thời gian sử dụng</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="time-schedule">
                            <div class="time-block start">
                                <div class="time-icon">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="time-info">
                                    <label>Bắt đầu</label>
                                    <span class="time-value">{{ formatDateTime(bookingDetail()!.thoiGianBatDau)
                                        }}</span>
                                </div>
                            </div>
                            <div class="time-separator">
                                <i class="fas fa-long-arrow-alt-right"></i>
                            </div>
                            <div class="time-block end">
                                <div class="time-icon">
                                    <i class="fas fa-stop"></i>
                                </div>
                                <div class="time-info">
                                    <label>Kết thúc</label>
                                    <span class="time-value">{{ formatDateTime(bookingDetail()!.thoiGianKetThuc)
                                        }}</span>
                                </div>
                            </div>
                        </div>

                        @if (bookingDetail()!.gioBatDauThucTe || bookingDetail()!.gioKetThucThucTe) {
                        <div class="actual-time">
                            <h4>Thời gian thực tế</h4>
                            <div class="actual-info">
                                @if (bookingDetail()!.gioBatDauThucTe) {
                                <div class="actual-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Bắt đầu: {{ formatDateTime(bookingDetail()!.gioBatDauThucTe!) }}</span>
                                </div>
                                }
                                @if (bookingDetail()!.gioKetThucThucTe) {
                                <div class="actual-item">
                                    <i class="fas fa-clock"></i>
                                    <span>Kết thúc: {{ formatDateTime(bookingDetail()!.gioKetThucThucTe!) }}</span>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <!-- Booking Details Card -->
                <div class="detail-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>Chi tiết đặt phòng</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            @if (bookingDetail()!.lyDo) {
                            <div class="info-item">
                                <label>Mục đích</label>
                                <span class="value">{{ bookingDetail()!.lyDo }}</span>
                            </div>
                            }
                            @if (bookingDetail()!.soLuong) {
                            <div class="info-item">
                                <label>Số lượng người</label>
                                <span class="value">{{ bookingDetail()!.soLuong }} người</span>
                            </div>
                            }
                            @if (bookingDetail()!.ngayDuyet) {
                            <div class="info-item">
                                <label>Ngày duyệt</label>
                                <span class="value">{{ formatDateTime(bookingDetail()!.ngayDuyet!) }}</span>
                            </div>
                            }
                            <div class="info-item">
                                <label>Ngày tạo</label>
                                <span class="value">{{ formatDate(bookingDetail()!.ngayMuon) }}</span>
                            </div>
                        </div>

                        @if (bookingDetail()!.ghiChu) {
                        <div class="note-section">
                            <label>Ghi chú</label>
                            <p class="note-content">{{ bookingDetail()!.ghiChu }}</p>
                        </div>
                        }
                    </div>
                </div>

                <!-- Room Condition Card -->
                @if (bookingDetail()!.tinhTrangPhong || bookingDetail()!.ghiChuSuDung) {
                <div class="detail-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-check"></i>
                            <h3>Tình trạng phòng</h3>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (bookingDetail()!.tinhTrangPhong) {
                        <div class="room-status">
                            <label>Tình trạng</label>
                            <span class="status-value" [class]="getRoomStatusClass(bookingDetail()!.tinhTrangPhong!)">{{
                                bookingDetail()!.tinhTrangPhong }}</span>
                        </div>
                        }
                        @if (bookingDetail()!.ghiChuSuDung) {
                        <div class="usage-note">
                            <label>Ghi chú sử dụng</label>
                            <p class="note-content">{{ bookingDetail()!.ghiChuSuDung }}</p>
                        </div>
                        }
                    </div>
                </div>
                }


            </div>

            <!-- Action Buttons -->
            @if (canShowActions()) {
            <div class="action-section">
                <div class="action-buttons">
                    <button class="action-btn secondary" (click)="goBack()">
                        <i class="fas fa-list"></i>
                        <span>Về danh sách</span>
                    </button>
                    @if (canExtend()) {
                    <button class="action-btn primary" (click)="confirmExtendBooking()" [disabled]="extendSubmitting()">
                        @if (extendSubmitting()) {
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Đang xử lý...</span>
                        } @else {
                        <i class="fas fa-clock"></i>
                        <span>Gia hạn (+2 giờ)</span>
                        }
                    </button>
                    }
                    @if (canCancel()) {
                    <button class="action-btn danger" (click)="openCancelModal()">
                        <i class="fas fa-times"></i>
                        <span>Hủy đặt phòng</span>
                    </button>
                    }
                </div>
            </div>
            }
        </div>
    </div>
    }

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-state">
        <div class="container">
            <div class="loading-content">
                <div class="spinner large"></div>
                <h3>Đang tải chi tiết đặt phòng...</h3>
                <p>Vui lòng đợi trong giây lát</p>
            </div>
        </div>
    </div>
    }

    <!-- Error State -->
    @if (error()) {
    <div class="error-state">
        <div class="container">
            <div class="error-content">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Không thể tải chi tiết</h3>
                <p>{{ error() }}</p>
                <div class="error-actions">
                    <button class="action-btn secondary" (click)="loadBookingDetail()">
                        <i class="fas fa-refresh"></i>
                        <span>Thử lại</span>
                    </button>
                    <button class="action-btn primary" (click)="goBack()">
                        <i class="fas fa-arrow-left"></i>
                        <span>Quay lại</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    }
</div>

<!-- Cancel Booking Modal -->
@if (showCancelModal()) {
<div class="modal-overlay" (click)="closeCancelModal()">
    <div class="cancel-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Hủy đặt phòng</h3>
            <button class="close-btn" (click)="closeCancelModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <p class="warning-text">
                <i class="fas fa-exclamation-triangle"></i>
                Bạn có chắc chắn muốn hủy đặt phòng này không? Hành động này không thể hoàn tác.
            </p>

            <div class="form-group">
                <label for="cancelReason">Lý do hủy <span class="required">*</span></label>
                <textarea id="cancelReason" [(ngModel)]="cancelReason" placeholder="Nhập lý do hủy đặt phòng..."
                    rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="cancelNote">Ghi chú thêm (tùy chọn)</label>
                <textarea id="cancelNote" [(ngModel)]="cancelNote" placeholder="Thêm ghi chú nếu cần..."
                    rows="2"></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" (click)="closeCancelModal()" [disabled]="cancelSubmitting()">
                <i class="fas fa-times"></i>
                Hủy
            </button>
            <button class="btn danger" (click)="submitCancelBooking()"
                [disabled]="!cancelReason().trim() || cancelSubmitting()">
                @if (cancelSubmitting()) {
                <i class="fas fa-spinner fa-spin"></i>
                Đang xử lý...
                } @else {
                <i class="fas fa-check"></i>
                Xác nhận hủy
                }
            </button>
        </div>
    </div>
</div>
}

<!-- Extend Booking Confirmation Modal -->
@if (showExtendConfirmModal()) {
<div class="modal-overlay" (click)="closeExtendConfirmModal()">
    <div class="extend-confirm-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>
                <i class="fas fa-clock"></i>
                Xác nhận gia hạn phòng
            </h3>
            <button class="close-btn" (click)="closeExtendConfirmModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            @if (bookingDetail()) {
            <div class="extend-confirm-content">
                <div class="room-info">
                    <div class="room-header">
                        <i class="fas fa-door-open"></i>
                        <h4>{{ bookingDetail()!.tenPhong }}</h4>
                    </div>
                    <span class="booking-id">#{{ bookingDetail()!.maDangKy }}</span>
                </div>

                <div class="time-info">
                    <div class="time-row current">
                        <span class="label">
                            <i class="fas fa-clock"></i>
                            Thời gian kết thúc hiện tại:
                        </span>
                        <span class="time">{{ formatDateTime(bookingDetail()!.thoiGianKetThuc) }}</span>
                    </div>

                    <div class="extend-arrow">
                        <i class="fas fa-arrow-down"></i>
                        <span>+2 giờ</span>
                    </div>

                    <div class="time-row new">
                        <span class="label">
                            <i class="fas fa-clock"></i>
                            Thời gian kết thúc mới:
                        </span>
                        <span class="time highlight">{{ getFormattedNewEndTime() }}</span>
                    </div>
                </div>

                <div class="warning-notice">
                    <div class="notice-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="notice-content">
                        <h5>Lưu ý quan trọng</h5>
                        <ul>
                            <li>Mỗi đăng ký chỉ được gia hạn <strong>1 lần duy nhất</strong></li>
                            <li>Thời gian gia hạn là <strong>2 giờ</strong> (không thể thay đổi)</li>
                            <li>Sau khi gia hạn, bạn không thể gia hạn thêm lần nữa</li>
                        </ul>
                    </div>
                </div>
            </div>
            }
        </div>

        <div class="modal-footer">
            <button class="btn secondary" (click)="closeExtendConfirmModal()" [disabled]="extendSubmitting()">
                <i class="fas fa-times"></i>
                Không, quay lại
            </button>
            <button class="btn primary" (click)="proceedWithExtend()" [disabled]="extendSubmitting()">
                @if (extendSubmitting()) {
                <i class="fas fa-spinner fa-spin"></i>
                Đang xử lý...
                } @else {
                <i class="fas fa-check"></i>
                Xác nhận gia hạn
                }
            </button>
        </div>
    </div>
</div>
}

<!-- Notification Toast -->
@if (showNotification()) {
<div class="notification-overlay">
    <div class="notification-toast" [ngClass]="'notification-' + notificationType()">
        <div class="notification-header">
            <div class="notification-icon">
                @switch (notificationType()) {
                @case ('success') {
                <i class="fas fa-check-circle"></i>
                }
                @case ('error') {
                <i class="fas fa-times-circle"></i>
                }
                @case ('warning') {
                <i class="fas fa-exclamation-triangle"></i>
                }
                }
            </div>
            <h4>{{ notificationTitle() }}</h4>
            <button class="notification-close" (click)="closeNotification()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-body">
            <p>{{ notificationMessage() }}</p>
        </div>
    </div>
</div>
}