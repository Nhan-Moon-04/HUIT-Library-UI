<div class="chat-page" *ngIf="isPageMode()">
    <!-- Chat as full page -->
    <div class="chat-page-header">
        <h2>Há»— trá»£ trá»±c tuyáº¿n</h2>
        <p *ngIf="!isStaffMode()">TrÃ² chuyá»‡n vá»›i trá»£ lÃ½ thÆ° viá»‡n HUIT</p>
        <p *ngIf="isStaffMode()">Chat vá»›i nhÃ¢n viÃªn há»— trá»£</p>

        <!-- Mode toggle buttons -->
        <div class="mode-toggle">
            <button [class.active]="!isStaffMode()" (click)="toggleMode()" class="btn-mode">
                ğŸ¤– Chat Bot
            </button>
            <button [class.active]="isStaffMode()" (click)="toggleMode()" class="btn-mode"
                [disabled]="!auth.isLoggedIn()">
                ğŸ‘¨â€ğŸ’¼ Chat NhÃ¢n viÃªn
            </button>
        </div>

        <!-- Staff session controls -->
        <div class="session-controls" *ngIf="isStaffMode() && auth.isLoggedIn()">
            <button (click)="toggleSessionList()" class="btn-sessions">
                ğŸ“‹ Lá»‹ch sá»­ chat ({{chatSessions().length}})
            </button>
            <button (click)="createNewStaffSession()" class="btn-new-session">
                â• Táº¡o phiÃªn má»›i
            </button>
            <button (click)="showMessageHistory()" class="btn-history" *ngIf="currentSession()">
                ğŸ“œ Xem lá»‹ch sá»­ tin nháº¯n
            </button>
        </div>

        <!-- Session list -->
        <div class="session-list" *ngIf="showSessionList() && isStaffMode()">
            <div class="session-item" *ngFor="let session of chatSessions()"
                [class.active]="currentSession()?.maPhienChat === session.maPhienChat" (click)="selectSession(session)">
                <div class="session-header">
                    <span class="session-id">PhiÃªn #{{session.maPhienChat}}</span>
                    <span class="session-status" [class.active]="session.isActive">
                        {{session.isActive ? 'ğŸŸ¢ Äang hoáº¡t Ä‘á»™ng' : 'ğŸ”´ ÄÃ£ káº¿t thÃºc'}}
                    </span>
                </div>
                <div class="session-details">
                    <div class="session-meta">
                        <span class="session-type">{{session.coBot ? 'ğŸ¤– Bot Chat' : 'ğŸ‘¨â€ğŸ’¼ NhÃ¢n viÃªn'}}</span>
                        <span class="message-count">{{session.soLuongTinNhan || 0}} tin nháº¯n</span>
                    </div>
                    <div class="session-time">
                        <small>Báº¯t Ä‘áº§u: {{formatDate(session.thoiGianBatDau)}}
                            {{formatTime(session.thoiGianBatDau)}}</small>
                    </div>
                    <div class="last-message" *ngIf="session.tinNhanCuoi">
                        <small>Tin nháº¯n cuá»‘i: "{{session.tinNhanCuoi}}"</small>
                        <small class="last-message-time" *ngIf="session.thoiGianTinNhanCuoi">
                            ({{formatTime(session.thoiGianTinNhanCuoi)}})
                        </small>
                    </div>
                </div>
            </div>
            <div class="no-sessions" *ngIf="chatSessions().length === 0">
                ğŸ“ ChÆ°a cÃ³ phiÃªn chat nÃ o. Nháº¥n "Táº¡o phiÃªn má»›i" Ä‘á»ƒ báº¯t Ä‘áº§u.
            </div>
        </div>
    </div>

    <div class="chat-page-container">
        <div class="chat-page-body" #chatBody>
            <div *ngFor="let m of messages()" class="message" [class.user-message]="!m.laBot"
                [class.bot-message]="m.laBot">
                <div class="message-wrapper">
                    <div class="avatar">
                        <i *ngIf="m.laBot" class="bot-icon">ğŸ¤–</i>
                        <i *ngIf="!m.laBot && !isStaffMode()" class="user-icon">ğŸ‘¤</i>
                        <i *ngIf="!m.laBot && isStaffMode()" class="user-icon">ğŸ‘¨â€ğŸ“</i>
                        <i *ngIf="!m.laBot && isStaffMode() && m.maNguoiGui !== auth.currentUser()?.maNguoiDung"
                            class="staff-icon">ğŸ‘¨â€ğŸ’¼</i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">{{ m.noiDung }}</div>
                        <div class="message-time" *ngIf="m.thoiGianGui">
                            {{ formatTime(m.thoiGianGui) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-page-footer">
            <input [ngModel]="draft()" (ngModelChange)="draft.set($event)" (keydown.enter)="send()"
                [placeholder]="isStaffMode() ? 'Nháº­p tin nháº¯n gá»­i nhÃ¢n viÃªn...' : 'Nháº­p tin nháº¯n...'" />
            <button (click)="send()">Gá»­i</button>
        </div>
    </div>
</div>

<div class="chat-widget" *ngIf="!isPageMode()">
    <button class="chat-toggle" (click)="toggle()" aria-label="Chat">
        <span *ngIf="!isOpen()" class="dot">ğŸ’¬</span>
        <span *ngIf="isOpen()" class="close">âœ•</span>
    </button>

    <div class="chat-panel" *ngIf="isOpen()">
        <div class="chat-header">
            <div class="header-title">
                <span *ngIf="!isStaffMode()">Trá»£ lÃ½ thÆ° viá»‡n</span>
                <span *ngIf="isStaffMode()">Chat nhÃ¢n viÃªn</span>
            </div>

            <!-- Mode toggle -->
            <div class="header-controls">
                <button (click)="toggleMode()" class="btn-toggle-mode" [disabled]="!auth.isLoggedIn() && isStaffMode()">
                    <span *ngIf="!isStaffMode()">ğŸ‘¨â€ğŸ’¼</span>
                    <span *ngIf="isStaffMode()">ğŸ¤–</span>
                </button>

                <button *ngIf="isStaffMode() && auth.isLoggedIn()" (click)="toggleSessionList()"
                    class="btn-sessions-mini">
                    ğŸ“‹
                </button>

                <button *ngIf="isStaffMode() && auth.isLoggedIn() && currentSession()" (click)="showMessageHistory()"
                    class="btn-history-mini">
                    ğŸ“œ
                </button>
            </div>
        </div>

        <!-- Session list (mini version) -->
        <div class="session-list-mini" *ngIf="showSessionList() && isStaffMode()">
            <div class="session-item-mini" *ngFor="let session of chatSessions()"
                [class.active]="currentSession()?.maPhienChat === session.maPhienChat" (click)="selectSession(session)">
                <div class="session-mini-header">
                    <span class="session-id-mini">PhiÃªn #{{session.maPhienChat}}</span>
                    <span class="session-status-mini" [class.active]="session.isActive">
                        {{session.isActive ? 'ğŸŸ¢' : 'ğŸ”´'}}
                    </span>
                </div>
                <div class="session-mini-details">
                    <small class="session-date-mini">{{formatDate(session.thoiGianBatDau)}}</small>
                    <small class="message-count-mini">{{session.soLuongTinNhan || 0}} tin nháº¯n</small>
                </div>
                <div class="session-mini-preview" *ngIf="session.tinNhanCuoi">
                    <small>"{{session.tinNhanCuoi.length > 20 ? session.tinNhanCuoi.substring(0, 20) + '...' :
                        session.tinNhanCuoi}}"</small>
                </div>
            </div>
            <button (click)="createNewStaffSession()" class="btn-new-session-mini">
                â• Táº¡o má»›i
            </button>
            <div class="no-sessions-mini" *ngIf="chatSessions().length === 0">
                <small>ğŸ“ ChÆ°a cÃ³ phiÃªn chat</small>
            </div>
        </div>

        <div class="chat-body" #chatBody>
            <div *ngFor="let m of messages()" class="message" [class.user-message]="!m.laBot"
                [class.bot-message]="m.laBot">
                <div class="message-wrapper">
                    <div class="avatar">
                        <i *ngIf="m.laBot" class="bot-icon">ğŸ¤–</i>
                        <i *ngIf="!m.laBot && !isStaffMode()" class="user-icon">ğŸ‘¤</i>
                        <i *ngIf="!m.laBot && isStaffMode()" class="user-icon">ğŸ‘¨â€ğŸ“</i>
                        <i *ngIf="!m.laBot && isStaffMode() && m.maNguoiGui !== auth.currentUser()?.maNguoiDung"
                            class="staff-icon">ğŸ‘¨â€ğŸ’¼</i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">{{ m.noiDung }}</div>
                        <div class="message-time" *ngIf="m.thoiGianGui">
                            {{ formatTime(m.thoiGianGui) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-footer">
            <input [ngModel]="draft()" (ngModelChange)="draft.set($event)" (keydown.enter)="send()"
                [placeholder]="isStaffMode() ? 'Nháº­p tin nháº¯n gá»­i nhÃ¢n viÃªn...' : 'Nháº­p tin nháº¯n...'" />
            <button (click)="send()">Gá»­i</button>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="history-modal-overlay" *ngIf="showHistoryModal()" (click)="closeHistoryModal()">
    <div class="history-modal" (click)="$event.stopPropagation()">
        <div class="history-header">
            <h3>Lá»‹ch sá»­ tin nháº¯n - PhiÃªn #{{currentSession()?.maPhienChat}}</h3>
            <button class="btn-close" (click)="closeHistoryModal()">âœ•</button>
        </div>

        <div class="history-body">
            <!-- Load more button -->
            <div class="load-more-section" *ngIf="hasMoreMessages()">
                <button (click)="loadMoreHistory()" class="btn-load-more" [disabled]="isLoadingHistory()">
                    <span *ngIf="!isLoadingHistory()">ğŸ“„ Táº£i tin nháº¯n cÅ© hÆ¡n</span>
                    <span *ngIf="isLoadingHistory()">ğŸ”„ Äang táº£i...</span>
                </button>
            </div>

            <!-- Messages -->
            <div class="history-messages">
                <div *ngFor="let m of messages(); trackBy: trackByMessageId" class="history-message"
                    [class.user-message]="isCurrentUserMessage(m)"
                    [class.staff-message]="!m.laBot && !isCurrentUserMessage(m)" [class.bot-message]="m.laBot">

                    <div class="message-info">
                        <span class="sender">
                            <span *ngIf="m.laBot">ğŸ¤– Bot</span>
                            <span *ngIf="!m.laBot && isCurrentUserMessage(m)">ğŸ‘¨â€ğŸ“ Báº¡n</span>
                            <span *ngIf="!m.laBot && !isCurrentUserMessage(m)">ğŸ‘¨â€ğŸ’¼ NhÃ¢n viÃªn</span>
                        </span>
                        <span class="timestamp" *ngIf="m.thoiGianGui">
                            {{formatDate(m.thoiGianGui)}} {{formatTime(m.thoiGianGui)}}
                        </span>
                    </div>

                    <div class="message-content">
                        {{m.noiDung}}
                    </div>
                </div>
            </div>

            <div class="no-more-messages" *ngIf="!hasMoreMessages() && messages().length > 0">
                ğŸ“ ÄÃ¢y lÃ  tin nháº¯n Ä‘áº§u tiÃªn trong phiÃªn chat nÃ y
            </div>

            <div class="no-messages" *ngIf="messages().length === 0 && !isLoadingHistory()">
                ğŸ’¬ ChÆ°a cÃ³ tin nháº¯n nÃ o trong phiÃªn chat nÃ y
            </div>
        </div>

        <div class="history-footer">
            <button (click)="closeHistoryModal()" class="btn-close-modal">ÄÃ³ng</button>
        </div>
    </div>
</div>