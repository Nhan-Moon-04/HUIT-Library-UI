<div class="profile-page">
    <!-- Hero -->
    <header class="profile-hero">
        <div class="hero-inner">
            <h1>Hồ sơ cá nhân</h1>
            <p>Quản lý thông tin tài khoản thư viện của bạn</p>
        </div>
    </header>

    <main class="profile-main">

        <div *ngIf="loading()" class="loading">Đang tải...</div>

        <div *ngIf="!loading() && profile()" class="profile-container">

            <!-- LEFT -->
            <div class="profile-left-card">
                <div class="avatar-wrapper">
                    <ng-container *ngIf="profile().avatar; else initials">
                        <img [src]="profile().avatar" alt="Avatar" />
                    </ng-container>
                    <ng-template #initials>
                        <div class="initials">
                            {{ (profile().hoTen || '') | slice:0:1 }}
                        </div>
                    </ng-template>
                </div>

                <h2 class="user-name">{{ profile().hoTen }}</h2>
                <div class="user-meta">
                    <span class="code">{{ profile().maDangNhap }}</span>
                    <span class="role">{{ profile().maVaiTro || auth.currentUser()?.vaiTro }}</span>
                </div>

                <button class="btn full primary" (click)="editProfile()">Chỉnh sửa hồ sơ</button>
                <button class="btn full outline" (click)="router.navigate(['/change-password'])">
                    Đổi mật khẩu
                </button>
            </div>

            <!-- RIGHT -->
            <div class="profile-right-card">
                <ng-container *ngIf="!editMode(); else editForm">

                    <div class="info-grid">

                        <div class="info-item">
                            <label>Email</label>
                            <p>{{ profile().email || '-' }}</p>
                        </div>

                        <div class="info-item">
                            <label>Số điện thoại</label>
                            <p>{{ profile().soDienThoai || '-' }}</p>
                        </div>

                        <div class="info-item">
                            <label>Mã người dùng</label>
                            <p>{{ profile().maNguoiDung }}</p>
                        </div>

                        <div class="info-item">
                            <label>Vai trò</label>
                            <p>{{ getRoleName(profile().maVaiTro) }}</p>
                        </div>

                    </div>
                </ng-container>

                <!-- EDIT MODE -->
                <ng-template #editForm>
                    <form [formGroup]="form" (ngSubmit)="saveProfile()">

                        <div class="form-row">
                            <label>Họ và tên *</label>
                            <input formControlName="fullName" [class.error]="isFieldInvalid('fullName')"
                                placeholder="Nhập họ và tên" />
                            <div *ngIf="isFieldInvalid('fullName')" class="error-message">
                                {{ getFieldError('fullName') }}
                            </div>
                        </div>

                        <div class="form-row">
                            <label>Email *</label>
                            <input formControlName="email" type="email" [class.error]="isFieldInvalid('email')"
                                placeholder="Nhập địa chỉ email" />
                            <div *ngIf="isFieldInvalid('email')" class="error-message">
                                {{ getFieldError('email') }}
                            </div>
                        </div>

                        <div class="form-row">
                            <label>Số điện thoại *</label>
                            <input formControlName="phoneNumber" [class.error]="isFieldInvalid('phoneNumber')"
                                placeholder="Nhập số điện thoại (10-11 số)" />
                            <div *ngIf="isFieldInvalid('phoneNumber')" class="error-message">
                                {{ getFieldError('phoneNumber') }}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn primary" [disabled]="form.invalid || loading()">
                                <span *ngIf="loading()">Đang lưu...</span>
                                <span *ngIf="!loading()">Lưu thay đổi</span>
                            </button>
                            <button class="btn outline" type="button" (click)="cancelEdit()" [disabled]="loading()">
                                Hủy bỏ
                            </button>
                        </div>
                    </form>
                </ng-template>
            </div>
        </div>

        <div *ngIf="!loading() && !profile()" class="no-data">
            Không có dữ liệu hồ sơ.
        </div>

    </main>
</div>