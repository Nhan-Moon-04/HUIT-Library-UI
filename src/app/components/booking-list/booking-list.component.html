<!-- Modern Library Booking Dashboard -->
<div class="library-dashboard">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="breadcrumb-nav">
                <button class="nav-btn" (click)="router.navigate(['/student-dashboard'])">
                    <i class="material-icons">arrow_back</i>
                    Trang chủ
                </button>
                <span class="separator">/</span>
                <span class="current-page">Phiếu đặt phòng</span>
            </div>

            <div class="header-actions">
                <button class="action-btn refresh-btn" (click)="loadBookings()" [disabled]="loading()">
                    <i class="material-icons" [class.spinning]="loading()">refresh</i>
                    <span>Làm mới</span>
                </button>
                <button class="action-btn primary-btn" (click)="router.navigate(['/booking/create'])">
                    <i class="material-icons">add</i>
                    <span>Đặt phòng mới</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Page Title & Stats -->
    <div class="page-title-section">
        <div class="title-content">
            <h1 class="page-title">
                <i class="material-icons">event_available</i>
                Phiếu Đặt Phòng
            </h1>
            <p class="page-subtitle">Quản lý các phiếu đặt phòng thư viện của bạn</p>
        </div>

        <div class="stats-cards" *ngIf="!loading() && bookings().length > 0">
            <div class="stat-card active">
                <div class="stat-number">{{ usingBookings().length }}</div>
                <div class="stat-label">Đang sử dụng</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-number">{{ getPendingCount() }}</div>
                <div class="stat-label">Chờ duyệt</div>
            </div>
            <div class="stat-card total">
                <div class="stat-number">{{ bookings().length }}</div>
                <div class="stat-label">Tổng cộng</div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div class="alerts-section" *ngIf="loading() || error() || message()">
        <div *ngIf="loading()" class="alert alert-info">
            <i class="material-icons">hourglass_empty</i>
            <span>Đang tải danh sách phiếu đặt phòng...</span>
        </div>
        <div *ngIf="error()" class="alert alert-error">
            <i class="material-icons">error</i>
            <span>{{ error() }}</span>
        </div>
        <div *ngIf="message()" class="alert alert-success">
            <i class="material-icons">check_circle</i>
            <span>{{ message() }}</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-area">
        <!-- Empty State -->
        <div *ngIf="!loading() && bookings().length === 0" class="empty-state">
            <div class="empty-illustration">
                <i class="material-icons">meeting_room</i>
            </div>
            <h2>Chưa có phiếu đặt phòng nào</h2>
            <p>Hãy tạo phiếu đặt phòng đầu tiên để sử dụng không gian học tập và tài nguyên thư viện.</p>
            <button class="cta-button" (click)="router.navigate(['/booking/create'])">
                <i class="material-icons">add_circle</i>
                Tạo phiếu đặt phòng đầu tiên
            </button>
        </div>

        <!-- Active Bookings Section -->
        <div *ngIf="!loading() && usingBookings().length > 0" class="bookings-section active-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="material-icons">play_circle</i>
                    <h2>Phiên Đang Sử Dụng</h2>
                    <span class="count-badge">{{ usingBookings().length }}</span>
                </div>
            </div>

            <div class="bookings-grid">
                <div class="booking-card active-booking" *ngFor="let booking of usingBookings()"
                    (click)="viewBookingDetail(booking.maDangKy)">
                    <div class="card-header">
                        <div class="room-info">
                            <h3 class="room-name">{{ booking.tenPhong }}</h3>
                            <span class="room-type">{{ booking.tenLoaiPhong }}</span>
                        </div>
                        <div class="status-indicator active">
                            <i class="material-icons">radio_button_checked</i>
                            <span>{{ booking.tenTrangThai }}</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="time-section">
                            <div class="time-item">
                                <i class="material-icons">schedule</i>
                                <div class="time-details">
                                    <span class="time-label">Bắt đầu</span>
                                    <span class="time-value">{{ formatDateTime(booking.thoiGianBatDau) }}</span>
                                </div>
                            </div>
                            <div class="time-item">
                                <i class="material-icons">event</i>
                                <div class="time-details">
                                    <span class="time-label">Kết thúc</span>
                                    <span class="time-value">{{ formatDateTime(booking.thoiGianKetThuc) }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="details-grid">
                            <div class="detail-item" *ngIf="booking.soLuong">
                                <i class="material-icons">group</i>
                                <span>{{ booking.soLuong }} người</span>
                            </div>
                            <div class="detail-item" *ngIf="booking.lyDo">
                                <i class="material-icons">description</i>
                                <span>{{ booking.lyDo }}</span>
                            </div>
                        </div>

                        <!-- Violation Alert -->
                        <div class="violation-alert" *ngIf="booking.coBienBan">
                            <div class="alert-content">
                                <i class="material-icons">warning</i>
                                <span class="alert-text">Có {{ booking.soLuongBienBan }} vi phạm - Cần xử lý</span>
                            </div>
                            <button class="view-violations-btn"
                                (click)="viewViolations(booking.maDangKy); $event.stopPropagation()">
                                <i class="material-icons">visibility</i>
                                Xem chi tiết
                            </button>
                        </div>

                        <div class="progress-section" *ngIf="booking.minutesRemaining > 0 && !booking.coBienBan">
                            <div class="time-remaining">
                                <i class="material-icons">timer</i>
                                <span>Còn {{ formatMinutes(booking.minutesRemaining) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-actions" *ngIf="booking.canExtend && !booking.coBienBan">
                        <button class="action-btn secondary"
                            (click)="openExtendModal(booking); $event.stopPropagation()">
                            <i class="material-icons">access_time</i>
                            Gia hạn
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming & Other Bookings -->
        <div *ngIf="!loading() && otherBookings().length > 0" class="bookings-section upcoming-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="material-icons">upcoming</i>
                    <h2>Sắp Tới & Lịch Sử</h2>
                    <span class="count-badge">{{ otherBookings().length }}</span>
                </div>
            </div>

            <div class="bookings-list">
                <div class="booking-item" *ngFor="let booking of otherBookings()"
                    [ngClass]="'status-' + booking.maTrangThai" (click)="viewBookingDetail(booking.maDangKy)">

                    <div class="item-status">
                        <div class="status-icon" [ngClass]="getStatusClass(booking.maTrangThai)">
                            <i class="material-icons">{{ getStatusIcon(booking.maTrangThai) }}</i>
                        </div>
                    </div>

                    <div class="item-content">
                        <div class="item-header">
                            <h3 class="room-name">{{ booking.tenPhong }}</h3>
                            <span class="booking-id">#{{ booking.maDangKy }}</span>
                        </div>

                        <div class="item-details">
                            <div class="detail-row">
                                <i class="material-icons">schedule</i>
                                <span>{{ formatDateTime(booking.thoiGianBatDau) }} - {{
                                    formatDateTime(booking.thoiGianKetThuc) }}</span>
                            </div>
                            <div class="detail-row" *ngIf="booking.lyDo">
                                <i class="material-icons">description</i>
                                <span>{{ booking.lyDo }}</span>
                            </div>
                        </div>

                        <!-- Violation warning for other bookings -->
                        <div class="violation-warning" *ngIf="booking.coBienBan">
                            <i class="material-icons">error</i>
                            <span>Có {{ booking.soLuongBienBan }} vi phạm</span>
                        </div>

                        <div class="item-meta">
                            <span class="status-text">{{ booking.tenTrangThai }}</span>
                            <span class="date-text">{{ formatDate(booking.ngayMuon) }}</span>
                        </div>

                        <!-- Countdown for approved bookings -->
                        <div class="countdown-section"
                            *ngIf="booking.maTrangThai === 2 && booking.minutesUntilStart > 0">
                            <div class="countdown-badge">
                                <i class="material-icons">schedule</i>
                                <span>Bắt đầu sau {{ formatMinutes(booking.minutesUntilStart) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="item-actions">
                        <div class="action-menu">
                            <button class="menu-btn" *ngIf="booking.canExtend"
                                (click)="openExtendModal(booking); $event.stopPropagation()" title="Gia hạn">
                                <i class="material-icons">access_time</i>
                            </button>
                            <button class="menu-btn" *ngIf="canCancelBooking(booking)"
                                (click)="openCancelModal(booking); $event.stopPropagation()" title="Hủy đặt phòng">
                                <i class="material-icons">cancel</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extend Modal -->
<div class="modal-overlay" *ngIf="showExtendModal()" (click)="closeExtendModal()">
    <div class="modal-container extend-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>
                <i class="material-icons">access_time</i>
                Gia Hạn Đặt Phòng
            </h2>
            <button class="close-btn" (click)="closeExtendModal()">
                <i class="material-icons">close</i>
            </button>
        </div>

        <div class="modal-body">
            <div class="booking-summary" *ngIf="selectedExtendBooking()">
                <h3>{{ selectedExtendBooking()!.tenPhong }}</h3>
                <p>Thời gian kết thúc hiện tại: {{ formatDateTime(selectedExtendBooking()!.thoiGianKetThuc) }}</p>
            </div>

            <div class="extend-options">
                <h4>Thời gian gia hạn</h4>
                <div class="time-picker">
                    <div class="time-group">
                        <label>Giờ</label>
                        <select class="time-select" [value]="extendHours()"
                            (change)="updateExtendHours(+$any($event.target).value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="time-group">
                        <label>Phút</label>
                        <select class="time-select" [value]="extendMinutes()"
                            (change)="updateExtendMinutes(+$any($event.target).value)">
                            <option value="0">0</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                    </div>
                </div>

                <div class="extension-preview" *ngIf="extendHours() > 0 || extendMinutes() > 0">
                    <p class="preview-text">
                        Thời gian kết thúc mới:
                        <strong>{{ getNewEndTime() }}</strong>
                    </p>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" (click)="closeExtendModal()">Hủy</button>
            <button class="btn primary" (click)="confirmExtend()"
                [disabled]="extendLoading() || (extendHours() === 0 && extendMinutes() === 0)">
                <i class="material-icons" *ngIf="extendLoading()">hourglass_empty</i>
                <i class="material-icons" *ngIf="!extendLoading()">check</i>
                {{ extendLoading() ? 'Đang gia hạn...' : 'Xác nhận gia hạn' }}
            </button>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal-overlay" *ngIf="showCancelModal()" (click)="closeCancelModal()">
    <div class="modal-container cancel-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>
                <i class="material-icons">cancel</i>
                Hủy Đặt Phòng
            </h2>
            <button class="close-btn" (click)="closeCancelModal()">
                <i class="material-icons">close</i>
            </button>
        </div>

        <div class="modal-body">
            <div class="booking-summary" *ngIf="selectedBooking()">
                <h3>{{ selectedBooking()!.tenPhong }}</h3>
                <p>{{ formatDateTime(selectedBooking()!.thoiGianBatDau) }} - {{
                    formatDateTime(selectedBooking()!.thoiGianKetThuc) }}</p>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label for="cancelReason">Lý do hủy *</label>
                    <textarea id="cancelReason" class="form-input" rows="3"
                        placeholder="Vui lòng cung cấp lý do hủy đặt phòng này..." [value]="cancelReason()"
                        (input)="updateCancelReason($any($event.target).value)" [disabled]="cancelLoading()"></textarea>
                </div>

                <div class="form-group">
                    <label for="cancelNote">Ghi chú thêm</label>
                    <textarea id="cancelNote" class="form-input" rows="2"
                        placeholder="Các bình luận bổ sung (tùy chọn)..." [value]="cancelNote()"
                        (input)="updateCancelNote($any($event.target).value)" [disabled]="cancelLoading()"></textarea>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" (click)="closeCancelModal()">Giữ đặt phòng</button>
            <button class="btn danger" (click)="confirmCancel()" [disabled]="cancelLoading() || !cancelReason().trim()">
                <i class="material-icons" *ngIf="cancelLoading()">hourglass_empty</i>
                <i class="material-icons" *ngIf="!cancelLoading()">cancel</i>
                {{ cancelLoading() ? 'Đang hủy...' : 'Xác nhận hủy' }}
            </button>
        </div>
    </div>
</div>