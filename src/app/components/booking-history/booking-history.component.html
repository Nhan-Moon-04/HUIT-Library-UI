<div class="modern-booking-history">
    <!-- Modern Header -->
    <div class="page-header">
        <div class="container">
            <div class="header-content">
                <div class="title-section">
                    <div class="icon-wrapper">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="title-text">
                        <h1>Lịch sử mượn phòng</h1>
                        <p>Quản lý và theo dõi lịch sử đặt phòng của bạn</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="modern-btn primary" (click)="navigateToBooking()">
                        <i class="fas fa-plus"></i>
                        <span>Đặt phòng mới</span>
                    </button>
                    <button class="modern-btn secondary" (click)="navigateToDashboard()">
                        <i class="fas fa-arrow-left"></i>
                        <span>Quay lại</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Search & Filter Bar -->
            <div class="search-filter-bar">
                <div class="search-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Tìm kiếm theo tên phòng, lý do, ghi chú..."
                            [value]="searchTerm()" (input)="updateSearchTerm($any($event.target).value)"
                            (keypress)="onSearchKeyPress($event)">
                        @if (searchTerm().length > 0) {

                        }
                    </div>
                    <button class="search-btn" (click)="onSearch()" [disabled]="loading()">
                        <i class="fas fa-search"></i>
                        Tìm kiếm
                    </button>
                    @if (isSearchMode()) {
                    <button class="reset-btn" (click)="resetSearch()">
                        <i class="fas fa-undo"></i>
                        Hiện tất cả
                    </button>
                    }
                </div>

                <div class="filter-section">
                    <label class="records-per-page">
                        <span>Hiển thị:</span>
                        <select [value]="pageSize()" (change)="onPageSizeChange($any($event.target).value)">
                            <option [value]="10">10 bản ghi</option>
                            <option [value]="25">25 bản ghi</option>
                            <option [value]="50">50 bản ghi</option>
                        </select>
                    </label>
                </div>
            </div>
            <!-- Status Messages -->
            @if (loading()) {
            <div class="status-card loading">
                <div class="status-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Đang tải lịch sử mượn phòng...</span>
                </div>
            </div>
            }

            @if (error()) {
            <div class="status-card error">
                <div class="status-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>{{ error() }}</span>
                </div>
            </div>
            }

            @if (!loading() && message() && isSearchMode() && totalItems() > 0) {
            <div class="status-card search-result">
                <div class="status-content">
                    <i class="fas fa-search"></i>
                    <span>{{ message() }}</span>
                </div>
            </div>
            }

            <!-- Results Header -->
            @if (!loading() && bookings().length > 0) {


            <!-- Booking Cards -->
            <div class="booking-cards">
                @for (booking of bookings(); track booking.maDangKy) {
                <div class="booking-card" [class]="getBookingClasses(booking)"
                    (click)="viewBookingDetail(booking.maDangKy)">

                    <!-- Card Header -->
                    <div class="card-header">
                        <div class="room-info">
                            <div class="status-indicator" [ngClass]="getHistoryStatusClass(booking.maTrangThai)">
                                <i class="fas" [ngClass]="getHistoryStatusIcon(booking.maTrangThai)"></i>
                            </div>
                            <div class="room-details">
                                <h4>{{ booking.tenPhong }}</h4>
                                <span class="room-type">{{ booking.tenLoaiPhong }}</span>
                            </div>
                        </div>

                        <div class="booking-id">
                            <span>#{{ booking.maDangKy }}</span>
                            @if (hasViolation(booking)) {
                            <div class="violation-badge" [class.urgent]="hasUnprocessedViolation(booking)">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>{{ getViolationCount(booking) }}</span>
                            </div>
                            }
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="card-body">
                        <div class="time-info">
                            <div class="time-row">
                                <i class="fas fa-calendar-alt"></i>
                                <span>{{ formatDateTime(booking.thoiGianBatDau) }}</span>
                                <span class="separator">-</span>
                                <span>{{ formatDateTime(booking.thoiGianKetThuc) }}</span>
                            </div>
                        </div>

                        <div class="details-grid">
                            @if (booking.soLuong) {
                            <div class="detail-item">
                                <i class="fas fa-users"></i>
                                <span>{{ booking.soLuong }} người</span>
                            </div>
                            }
                            @if (booking.lyDo) {
                            <div class="detail-item purpose">
                                <i class="fas fa-clipboard-list"></i>
                                <span>{{ booking.lyDo }}</span>
                            </div>
                            }
                        </div>

                        @if (booking.ghiChu || booking.ghiChuSuDung) {
                        <div class="note-section">
                            <i class="fas fa-sticky-note"></i>
                            <span>{{ booking.ghiChu || booking.ghiChuSuDung }}</span>
                        </div>
                        }

                        @if (hasViolation(booking)) {
                        <div class="violation-section">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="violation-text">
                                Có {{ getViolationCount(booking) }} vi phạm
                                @if (hasUnprocessedViolation(booking)) {
                                <span class="unprocessed-label">Chưa xử lý</span>
                                }
                            </span>
                        </div>
                        }
                    </div>

                    <!-- Card Footer -->
                    <div class="card-footer">
                        <div class="status-section">
                            <span class="status-badge" [ngClass]="getHistoryStatusClass(booking.maTrangThai)">
                                {{ booking.tenTrangThai }}
                            </span>
                            <span class="date-info">{{ formatDateTime(booking.ngayMuon) }}</span>
                        </div>

                        <div class="action-buttons">
                            <!-- Evaluation Button -->
                            @if (booking.coTheDanhGia || booking.daDanhGia) {
                            <button class="evaluation-btn" [ngClass]="booking.daDanhGia ? 'evaluated' : 'can-evaluate'"
                                (click)="handleEvaluationAction(booking); $event.stopPropagation()"
                                [title]="booking.trangThaiDanhGia">
                                @if (booking.daDanhGia) {
                                <i class="fas fa-star"></i>
                                <span>Xem đánh giá</span>
                                } @else {
                                <i class="fas fa-star"></i>
                                <span>Đánh giá</span>
                                }
                            </button>
                            }

                            <button class="view-detail-btn"
                                (click)="viewBookingDetail(booking.maDangKy); $event.stopPropagation()">
                                <i class="fas fa-eye"></i>
                                <span>Chi tiết</span>
                            </button>
                        </div>
                    </div>
                </div>
                }
            </div>

            <!-- Modern Pagination -->
            @if (totalPages() > 1) {
            <div class="modern-pagination">
                <div class="pagination-info">
                    <span>{{ getPaginationInfo() }}</span>
                </div>

                <div class="pagination-controls">
                    <button class="page-btn" (click)="goToFirstPage()" [disabled]="pageNumber() <= 1" title="Trang đầu">
                        <i class="fas fa-angle-double-left"></i>
                    </button>

                    <button class="page-btn" (click)="prev()" [disabled]="pageNumber() <= 1" title="Trang trước">
                        <i class="fas fa-angle-left"></i>
                    </button>

                    @if (shouldShowFirstEllipsis()) {
                    <button class="page-btn" (click)="goToPage(1)" [class.active]="pageNumber() === 1">
                        1
                    </button>
                    <span class="ellipsis">...</span>
                    }

                    @for (page of getVisiblePageNumbers(); track page) {
                    <button class="page-btn" (click)="goToPage(page)" [class.active]="pageNumber() === page">
                        {{ page }}
                    </button>
                    }

                    @if (shouldShowLastEllipsis()) {
                    <span class="ellipsis">...</span>
                    <button class="page-btn" (click)="goToPage(totalPages())"
                        [class.active]="pageNumber() === totalPages()">
                        {{ totalPages() }}
                    </button>
                    }

                    <button class="page-btn" (click)="next()" [disabled]="pageNumber() >= totalPages()"
                        title="Trang sau">
                        <i class="fas fa-angle-right"></i>
                    </button>

                    <button class="page-btn" (click)="goToLastPage()" [disabled]="pageNumber() >= totalPages()"
                        title="Trang cuối">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
            }
            }

            <!-- Empty State -->
            @if (!loading() && bookings().length === 0 && !isSearchMode()) {
            <div class="empty-state">
                <div class="empty-illustration">
                    <i class="fas fa-history"></i>
                </div>
                <div class="empty-content">
                    <h3>Chưa có lịch sử mượn phòng</h3>
                    <p>Bạn chưa có bất kỳ bản ghi mượn phòng nào trong hệ thống.<br>
                        Hãy đặt phòng để bắt đầu sử dụng dịch vụ của thư viện.</p>
                    <button class="modern-btn primary large" (click)="navigateToBooking()">
                        <i class="fas fa-plus"></i>
                        <span>Đặt phòng ngay</span>
                    </button>
                </div>
            </div>
            }

            <!-- Search Empty State -->
            @if (!loading() && bookings().length === 0 && isSearchMode()) {
            <div class="empty-state">
                <div class="empty-illustration">
                    <i class="fas fa-search"></i>
                </div>
                <div class="empty-content">
                    <h3>Không tìm thấy kết quả</h3>
                    <p>Không tìm thấy lịch sử mượn phòng nào phù hợp với từ khóa "<strong>{{ searchTerm()
                            }}</strong>".<br>
                        Hãy thử tìm kiếm với từ khóa khác hoặc xem tất cả lịch sử.</p>
                    <button class="modern-btn secondary large" (click)="resetSearch()">
                        <i class="fas fa-undo"></i>
                        <span>Hiện tất cả</span>
                    </button>
                </div>
            </div>
            }
        </div>
    </div>
</div>

<!-- Evaluation Modal -->
<app-evaluation-modal [isVisible]="showEvaluationModal()" [mode]="evaluationMode()"
    [booking]="selectedBookingForEvaluation()" (closeModal)="closeEvaluationModal()"
    (evaluationSaved)="onEvaluationSaved()"></app-evaluation-modal>