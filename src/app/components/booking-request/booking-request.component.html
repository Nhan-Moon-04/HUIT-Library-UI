<div class="booking-page modern">
    <div class="top-row">
        <button class="back-btn" type="button" (click)="goBack()">← Trở về</button>
        <div class="title-area">
            <h2>Yêu cầu mượn phòng</h2>
            <p class="subtitle">Gửi yêu cầu đặt phòng học / nhóm tại Thư viện HUIT</p>
        </div>
    </div>

    <div class="messages-row">
        <div *ngIf="loading()" class="loading">Đang gửi...</div>
        <div *ngIf="success()" class="success">{{ success() }}</div>
        <div *ngIf="error()" class="error prewrap">{{ error() }}</div>
    </div>

    <form (ngSubmit)="submit()" [formGroup]="form" novalidate>
        <div class="form-grid">
            <div class="form-col form-left">
                <label>Loại phòng <span class="req"
                        *ngIf="form.get('maLoaiPhong')?.hasError('required') && form.get('maLoaiPhong')?.touched">(bắt
                        buộc)</span></label>
                <div class="select-wrap">
                    <select formControlName="maLoaiPhong"
                        [class.invalid]="form.get('maLoaiPhong')?.invalid && form.get('maLoaiPhong')?.touched">
                        <option value="">-- Chọn loại phòng --</option>
                        @for (roomType of roomTypes(); track roomType.maLoaiPhong) {
                        <option [value]="roomType.maLoaiPhong">{{ roomType.tenLoaiPhong }} - {{ roomType.viTri }}
                        </option>
                        }
                    </select>
                    <i class="fas fa-chevron-down select-icon"></i>
                </div>
                <div class="field-error" *ngIf="form.get('maLoaiPhong')?.invalid && form.get('maLoaiPhong')?.touched">
                    Loại phòng là bắt buộc.</div>

                <div class="datetime-group">
                    <h4 class="datetime-title">
                        <i class="fas fa-calendar-alt"></i>
                        Thời gian bắt đầu
                    </h4>

                    <div class="datetime-row">
                        <div class="datetime-col">
                            <label>Chọn ngày <span class="req"
                                    *ngIf="form.get('ngayBatDau')?.hasError('required') && form.get('ngayBatDau')?.touched">(bắt
                                    buộc)</span></label>
                            <input formControlName="ngayBatDau" type="date"
                                [class.invalid]="form.get('ngayBatDau')?.invalid && form.get('ngayBatDau')?.touched" />
                            <div class="field-error"
                                *ngIf="form.get('ngayBatDau')?.invalid && form.get('ngayBatDau')?.touched">
                                Vui lòng chọn ngày.
                            </div>
                        </div>

                        <div class="datetime-col">
                            <label>Chọn giờ <span class="req"
                                    *ngIf="form.get('gioBatDau')?.hasError('required') && form.get('gioBatDau')?.touched">(bắt
                                    buộc)</span></label>
                            <input formControlName="gioBatDau" type="time"
                                [class.invalid]="form.get('gioBatDau')?.invalid && form.get('gioBatDau')?.touched" />
                            <div class="field-error"
                                *ngIf="form.get('gioBatDau')?.invalid && form.get('gioBatDau')?.touched">
                                Vui lòng chọn giờ.
                            </div>
                        </div>
                    </div>

                    <small class="form-helper">
                        <i class="fas fa-info-circle"></i>
                        Thời gian sử dụng: 2 giờ (tự động tính từ thời gian bắt đầu)
                    </small>
                </div>

                <div class="form-row">
                    <label>Mục đích sử dụng</label>
                    <textarea formControlName="lyDo" placeholder="Ví dụ: Học nhóm, làm báo cáo, ôn thi..."></textarea>
                </div>

                <div class="actions">
                    <button type="submit" class="btn primary" [disabled]="loading()">Gửi yêu
                        cầu</button>
                    <button type="button" class="btn outline" (click)="form.reset()">Reset</button>
                </div>
            </div>

            <aside class="form-col form-right">
                <div class="panel">
                    <h4>Thông tin phòng</h4>
                    @if (form.get('maLoaiPhong')?.value) {
                    @if (getSelectedRoomType(); as selectedRoom) {
                    <div class="selected-room-details">
                        <p><strong>Tên:</strong> {{ selectedRoom.tenLoaiPhong }}</p>
                        <p><strong>Mô tả:</strong> {{ selectedRoom.moTa }}</p>
                        <p><strong>Vị trí:</strong> {{ selectedRoom.viTri }}</p>
                        <p><strong>Trang thiết bị:</strong> {{ selectedRoom.trangThietBi }}</p>
                        <p><strong>Số chỗ:</strong> {{ selectedRoom.soLuongChoNgoi }}</p>
                        <p><strong>Thời gian sử dụng:</strong> {{ selectedRoom.thoiGianSuDung }}</p>
                    </div>
                    }
                    }
                    @if (!form.get('maLoaiPhong')?.value) {
                    <p class="muted">Chọn loại phòng để xem chi tiết và yêu cầu.</p>
                    }

                    <hr />
                    <h5>Tóm tắt yêu cầu</h5>
                    <div class="summary">
                        <p><strong>Loại phòng:</strong> {{ getSelectedRoomType()?.tenLoaiPhong || '-' }}</p>
                        <p><strong>Bắt đầu:</strong> {{ getFormattedDateTime() }}</p>
                        <p><strong>Thời lượng:</strong> 2 giờ (tự động)</p>
                        <p><strong>Mục đích:</strong> {{ form.value.lyDo || '-' }}</p>
                    </div>
                </div>
            </aside>
        </div>
    </form>
</div>