<div class="library-booking-system">
    <!-- Header Section -->
    <header class="booking-header">
        <div class="header-container">
            <button class="back-button" (click)="goBack()" aria-label="Quay lại">
            <i class="fas fa-arrow-left"></i>
            <span>Quay lại</span>
        </button>

            <div class="header-content">
                <div class="header-title">
                    <h1>Đặt phòng học tập</h1>
                    <p>Thư viện Trường Đại học Công Thương TP.HCM</p>
                </div>

                <div class="header-logo">
                    <div class="logo-circle">
                        <i class="fas fa-book-open"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="progress-wrapper">
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step" [class.active]="currentStep() === 1" [class.completed]="currentStep() > 1"
                    [class.clickable]="currentStep() > 1" (click)="goToStep(1)">
                    <div class="step-circle">
                        <i class="fas fa-calendar-check" *ngIf="currentStep() > 1; else step1Icon"></i>
                        <ng-template #step1Icon><span>1</span></ng-template>
                    </div>
                    <span class="step-label">Chọn thời gian</span>
                </div>

                <div class="step-connector" [class.completed]="currentStep() > 1"></div>

                <div class="step" [class.active]="currentStep() === 2" [class.completed]="currentStep() > 2"
                    [class.clickable]="currentStep() > 2" (click)="goToStep(2)">
                    <div class="step-circle">
                        <i class="fas fa-door-open" *ngIf="currentStep() > 2; else step2Icon"></i>
                        <ng-template #step2Icon><span>2</span></ng-template>
                    </div>
                    <span class="step-label">Chọn phòng</span>
                </div>

                <div class="step-connector" [class.completed]="currentStep() > 2"></div>

                <div class="step" [class.active]="currentStep() === 3" [class.completed]="currentStep() > 3"
                    [class.clickable]="currentStep() > 3" (click)="goToStep(3)">
                    <div class="step-circle">
                        <i class="fas fa-user-edit" *ngIf="currentStep() > 3; else step3Icon"></i>
                        <ng-template #step3Icon><span>3</span></ng-template>
                    </div>
                    <span class="step-label">Thông tin</span>
                </div>

                <div class="step-connector" [class.completed]="currentStep() > 3"></div>

                <div class="step" [class.active]="currentStep() === 4">
                    <div class="step-circle">
                        <span>4</span>
                    </div>
                    <span class="step-label">Xác nhận</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="booking-main">
        <div class="booking-container">
            <!-- Alert Messages -->
            <div class="alert-container" *ngIf="loading() || success() || error()">
                <div class="alert alert-loading" *ngIf="loading()">
                    <div class="alert-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
                    <div class="alert-content">
                        <h4>Đang xử lý</h4>
                        <p>Vui lòng đợi trong giây lát...</p>
                    </div>
                </div>

                <div class="alert alert-success" *ngIf="success()">
                    <div class="alert-icon">
                <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Thành công</h4>
                        <p>{{ success() }}</p>
                    </div>
                </div>

                <div class="alert alert-error" *ngIf="error()">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Có lỗi xảy ra</h4>
                        <p>{{ error() }}</p>
                    </div>
                </div>
            </div>

            <!-- Form Steps -->
            <form [formGroup]="form" (ngSubmit)="submit()" class="booking-form">

                <!-- Step 1: Time Selection -->
                <div class="step-content" *ngIf="currentStep() === 1">
                    <div class="step-header">
                        <h2>Chọn thời gian sử dụng</h2>
                        <p>Vui lòng chọn ngày và giờ bạn muốn sử dụng phòng</p>
                    </div>

                    <div class="time-selection-grid">
                        <!-- Date Picker -->
                        <div class="date-picker-section">
                            <label class="field-label">
                                <i class="fas fa-calendar-alt"></i> Chọn ngày
                            </label>
                            <input type="date" formControlName="ngayBatDau" class="form-control" [min]="getTodayDate()">
                            <small class="text-muted">Định dạng: dd/mm/yyyy</small>
                            <div *ngIf="form.get('ngayBatDau')?.invalid && form.get('ngayBatDau')?.touched"
                                class="text-danger">
                                Vui lòng chọn ngày hợp lệ
                            </div>

                            <div class="operating-hours mt-3">
                                <h4><i class="fas fa-clock"></i> Giờ hoạt động</h4>
                                <p>Thứ 2 - Thứ 6: 08:00 - 21:30</p>
                                <p>Thứ 7 - Chủ nhật: 08:00 - 17:00</p>
                            </div>
                        </div>

                        <!-- Time Picker -->
                        <div class="time-picker-section">
                            <label class="field-label">
                                <i class="fas fa-clock"></i> Chọn giờ bắt đầu
                            </label>
                            <input type="time" formControlName="gioBatDau" class="form-control" step="1800">
                            <!-- 30 phút -->
                            <small class="text-muted">Khoảng cách 30 phút (08:00, 08:30, ...) - Thời lượng mặc định: 2
                                giờ</small>
                            <div *ngIf="isDateTimeInPast()" class="text-danger mt-2">
                <i class="fas fa-exclamation-circle"></i>
                                Thời gian phải lớn hơn thời điểm hiện tại
                            </div>
            </div>
        </div>

                    <div class="step-actions mt-4">
                        <button type="button" class="btn btn-primary"
                            [disabled]="!canProceedToStep2() || isDateTimeInPast()" (click)="nextStep()">
                            Tiếp tục <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <!-- Step 2: Room Selection -->
                <div class="step-content" *ngIf="currentStep() === 2">
                    <div class="step-header">
                        <h2>Chọn loại phòng</h2>
                        <p>Lựa chọn phòng phù hợp với nhu cầu của bạn</p>
                    </div>

                    <div class="room-grid">
                        <div class="room-card" *ngFor="let roomType of roomTypes()"
                            [class.selected]="isRoomTypeSelected(roomType)" (click)="selectRoomType(roomType)">
                            <div class="room-image">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="room-details">
                                <h3>{{ roomType.tenLoaiPhong }}</h3>
                                <div class="room-specs">
                                    <div class="spec-item">
                                            <i class="fas fa-users"></i>
                                        <span>{{ roomType.soLuongChoNgoi }} chỗ</span>
                                    </div>
                                    <div class="spec-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ roomType.viTri }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <i class="fas fa-tools"></i>
                                        <span>{{ roomType.trangThietBi }}</span>
                                    </div>
                                </div>
                                <p class="room-description">{{ roomType.moTa }}</p>
                            </div>
                            <div class="selection-indicator">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                                    </div>

                    <div class="step-actions">
                        <button type="button" class="btn btn-back" (click)="previousStep()">
                            <i class="fas fa-arrow-left"></i>
                            Quay lại bước 1
                        </button>
                        <button type="button" class="btn btn-next" [disabled]="!canProceedToStep3()"
                            (click)="nextStep()">
                            Tiếp tục
                            <i class="fas fa-arrow-right"></i>
                        </button>
                                    </div>
                                </div>

                <!-- Step 3: User Information -->
                <div class="step-content" *ngIf="currentStep() === 3">
                    <div class="step-header">
                        <h2>Thông tin sử dụng</h2>
                        <p>Cung cấp thông tin chi tiết về mục đích sử dụng</p>
                                    </div>

                    <div class="info-form">
                        <div class="form-row">
                            <div class="form-field">
                                <label class="field-label">
                                    <i class="fas fa-users"></i>
                                    Số người tham gia
                                    <span class="required">*</span>
                                </label>
                                <input type="number" formControlName="soLuong" class="form-input"
                                    [class.error]="(form.get('soLuong')?.invalid && form.get('soLuong')?.touched) || !isCapacityValid()"
                                    placeholder="Nhập số người tham gia" [min]="getMinCapacity()"
                                    [max]="getMaxCapacity()">
                                <small class="text-muted" *ngIf="selectedRoomType()">
                                    Tối thiểu: {{getMinCapacity()}} người - Tối đa: {{getMaxCapacity()}} người
                                </small>
                                <div class="field-error"
                                    *ngIf="(form.get('soLuong')?.invalid && form.get('soLuong')?.touched) || !isCapacityValid()">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{getCapacityErrorMessage() || 'Số người không hợp lệ'}}
                                </div>
                            </div>

                            <div class="time-note">
                                <i class="fas fa-info-circle"></i>
                                <span>Thời gian sử dụng mặc định: <strong>2 giờ</strong> (tự động tính từ thời gian bắt
                                    đầu)</span>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-clipboard-list"></i>
                                THÔNG TIN SỬ DỤNG
                            </h3>

                            <div class="form-group">
                                <label class="form-label">
                                    Mục đích sử dụng
                                    <span class="required"
                                        *ngIf="form.get('lyDo')?.hasError('required') && form.get('lyDo')?.touched">*</span>
                                </label>
                                <textarea formControlName="lyDo"
                                    [class.error]="form.get('lyDo')?.invalid && form.get('lyDo')?.touched"
                                    class="form-textarea"
                                    placeholder="Vui lòng mô tả mục đích sử dụng phòng (ví dụ: Học nhóm môn Toán, làm bài tập nhóm, ôn thi cuối kỳ...)"></textarea>
                                <div class="error-message"
                                    *ngIf="form.get('lyDo')?.invalid && form.get('lyDo')?.touched">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Vui lòng nhập mục đích sử dụng
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Số lượng người tham gia
                                    <span class="required"
                                        *ngIf="form.get('soLuong')?.hasError('required') && form.get('soLuong')?.touched">*</span>
                                </label>
                                <input type="number" formControlName="soLuong"
                                    [class.error]="form.get('soLuong')?.invalid && form.get('soLuong')?.touched"
                                    class="form-input" placeholder="Nhập số lượng người tham gia" min="1" max="50" />
                                <div class="error-message"
                                    *ngIf="form.get('soLuong')?.invalid && form.get('soLuong')?.touched">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Số lượng người tham gia phải từ 1 đến 50
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sticky-note"></i>
                                    Ghi chú thêm (tùy chọn)
                                </label>
                                <textarea formControlName="ghiChu" class="form-textarea"
                                    placeholder="Yêu cầu đặc biệt, thiết bị cần thêm, hoặc thông tin khác..."></textarea>
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i>
                                    Ghi chú về trang thiết bị hoặc yêu cầu đặc biệt (nếu có)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Summary -->
                    <div class="summary-column">
                        <div class="summary-card">
                            <div class="summary-header">
                                <h3>
                                    <i class="fas fa-file-alt"></i>
                                    TÓM TẮT YÊU CẦU
                                </h3>
                            </div>

                            <div class="summary-content">
                                <div class="summary-item">
                                    <label>Loại phòng:</label>
                                    <span class="value">{{ getSelectedRoomType()?.tenLoaiPhong || 'Chưa chọn' }}</span>
                                </div>

                                <div class="summary-item">
                                    <label>Thời gian:</label>
                                    <span class="value">{{ getFormattedDateTime() || 'Chưa chọn' }}</span>
                                </div>

                                <div class="summary-item">
                                    <label>Thời lượng:</label>
                                    <span class="value">2 giờ</span>
                                </div>

                                <div class="summary-item">
                                    <label>Số người:</label>
                                    <span class="value">{{ form.value.soLuong || 'Chưa nhập' }}</span>
                                </div>

                                <div class="summary-item">
                                    <label>Mục đích:</label>
                                    <span class="value purpose">{{ form.value.lyDo || 'Chưa nhập' }}</span>
                                </div>

                                <div *ngIf="form.value.ghiChu" class="summary-item">
                                    <label>Ghi chú:</label>
                                    <span class="value note">{{ form.value.ghiChu }}</span>
                                </div>
                            </div>

                            <div class="summary-actions">
                                <button type="submit" class="btn btn-primary" [disabled]="loading() || form.invalid">
                                    <i class="fas fa-paper-plane"></i>
                                    GỬI YÊU CẦU ĐẶT PHÒNG
                                </button>

                                <button type="button" class="btn btn-secondary" (click)="form.reset()">
                                    <i class="fas fa-redo"></i>
                                    ĐẶT LẠI
                                </button>
                            </div>

                            <div class="summary-note">
                                <h4>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    LƯU Ý QUAN TRỌNG
                                </h4>
                                <ul>
                                    <li>Yêu cầu sẽ được xét duyệt trong vòng 24 giờ</li>
                                    <li>Vui lòng đến sớm 15 phút trước giờ đặt</li>
                                    <li>Tuân thủ nội quy sử dụng phòng của thư viện</li>
                                    <li>Liên hệ quầy thư viện nếu có thay đổi</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
